#! /usr/bin/env bash

# ffmpeg -y -i STREAM_URL foo.mp3

if command -v sk > /dev/null; then
    search=sk
elif command -v fzf > /dev/null; then
    search=fzf
else
    echo "No search command found; please install one of 'skim' or 'fzf'"
    exit 1
fi

declare -A stations

stations=(
    ["BBC Radio 1"]='http://as-hls-ww-live.akamaized.net/pool_904/live/ww/bbc_radio_one/bbc_radio_one.isml/bbc_radio_one-audio%3d96000.norewind.m3u8'
    ["BBC Radio 2"]='http://as-hls-ww-live.akamaized.net/pool_904/live/ww/bbc_radio_two/bbc_radio_two.isml/bbc_radio_two-audio%3d96000.norewind.m3u8'
    ["BBC Radio 3"]='http://as-hls-ww-live.akamaized.net/pool_904/live/ww/bbc_radio_three/bbc_radio_three.isml/bbc_radio_three-audio%3d96000.norewind.m3u8'
    ["BBC Radio 4 FM"]='http://as-hls-ww-live.akamaized.net/pool_904/live/ww/bbc_radio_fourfm/bbc_radio_fourfm.isml/bbc_radio_fourfm-audio%3d96000.norewind.m3u8'
    ["BBC Radio 4 LW"]='http://as-hls-ww-live.akamaized.net/pool_904/live/ww/bbc_radio_fourlw/bbc_radio_fourlw.isml/bbc_radio_fourlw-audio%3d96000.norewind.m3u8'
    ["BBC World Service News"]='http://a.files.bbci.co.uk/media/live/manifesto/audio/simulcast/hls/nonuk/sbr_low/ak/bbc_world_service.m3u8'
)


function play {
    url=$1

    case $(uname) in
        Darwin)
            if [ -e /Applications/VLC.app/Contents/MacOS/VLC ]; then
                /Applications/VLC.app/Contents/MacOS/VLC "$url" 2>/dev/null &
            elif [ -e /Applications/mpv.app/Contents/MacOS/mpv ]; then
                /Applications/mpv.app/Contents/MacOS/mpv "$url"
            else
                open "$url"
            fi
            ;;
        *)
            cvlc "$url"
    esac

}

station=$(for k in "${!stations[@]}"; do echo "$k"; done | sort -r | $search)

if [ -n "$station" ]; then
    play "${stations[$station]}"
fi
